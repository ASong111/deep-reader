# 智能章节合并系统技术文档

## 概述

智能章节合并系统（Reading Unit Builder）是 Deep Reader 的核心技术之一，旨在解决传统电子书阅读器章节过碎的问题。通过 6 维度评分模型和 4 层决策优先级，系统能够智能地判断章节是否应该合并，生成符合人类阅读节奏的章节结构。

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    Parser (格式相关)                          │
│              EPUB / PDF / TXT / Markdown / HTML              │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                  Segment Builder                             │
│  • 从 Parser 输出构建候选片段                                  │
│  • 计算正文长度、位置比例                                       │
│  • 提取标题信息、TOC 层级                                       │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                Feature Extractor                             │
│  • TOC 特征（层级）                                            │
│  • 标题强度（强章/弱标题/无标题）                                │
│  • 长度特征（5 个级别）                                         │
│  • 内容类型（版权页/目录/序言/正文）                             │
│  • 位置特征（前 5%/后 5%/紧跟强章）                             │
│  • 连续性特征（编号连续性）                                      │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                  Scoring Engine                              │
│  • TOC 语义分（权重 1.5）                                      │
│  • 标题强度分（权重 1.2）                                       │
│  • 长度合理性分（权重 1.0）                                     │
│  • 内容类型分（权重 1.0）                                       │
│  • 位置惩罚分（权重 0.8）                                       │
│  • 连续性分（权重 0.8）                                         │
│  → 加权总分                                                    │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                 Decision Engine                              │
│  优先级 1: 内容类型判断（content_score >= 5）                  │
│  优先级 2: TOC 一级节点 + 非元信息                             │
│  优先级 3: TOC 二级节点                                        │
│  优先级 4: 评分模型（阈值判断）                                 │
│  灰区处理: 长度 < 800 合并，否则创建新章节                      │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              Reading Unit Builder                            │
│  • 根据决策构建最终章节结构                                     │
│  • 处理章-节两层层级关系                                        │
│  • 标记 contentType（frontmatter/body/backmatter）           │
│  • 自动关联 parent_id                                         │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                  持久化到数据库                                │
│  • reading_units 表                                          │
│  • debug_segment_scores 表（调试数据）                        │
└─────────────────────────────────────────────────────────────┘
```

## 核心模块

### 1. Segment Builder

**职责**: 从 Parser 输出构建候选片段

**输入**:
- `ChapterData[]` - Parser 解析的章节列表
- 数据库连接

**输出**:
- `Segment[]` - 候选片段列表

**关键功能**:
- 计算正文长度（排除标题）
- 计算位置比例（0.0 ~ 1.0）
- 提取标题信息
- 查询 block ID 范围
- 支持 TOC 层级映射（EPUB/HTML）

**代码位置**: `src-tauri/src/reading_unit/segment_builder.rs`

---

### 2. Feature Extractor

**职责**: 从 Segment 中提取用于评分的特征

**输入**:
- `Segment` - 当前片段
- `Option<Segment>` - 上一个片段（用于判断连续性）

**输出**:
- `SegmentFeatures` - 提取的特征

**特征维度**:

| 特征 | 类型 | 说明 |
|-----|------|------|
| toc_feature | Option<u32> | TOC 层级（1/2/3+） |
| heading_feature | HeadingStrength | 标题强度（Strong/Weak/None） |
| length_feature | LengthFeature | 长度级别（VeryShort/Short/Medium/Long/VeryLong） |
| content_feature | ContentFeature | 内容类型（Copyright/Toc/Preface/Body） |
| position_in_book | f64 | 在书中的位置（0.0 ~ 1.0） |
| is_after_strong_heading | bool | 是否紧跟强章标题 |
| is_consecutive_strong_heading | bool | 是否连续两个强章标题 |
| numbering_continuity | Option<bool> | 编号连续性 |

**代码位置**: `src-tauri/src/reading_unit/feature_extractor.rs`

---

### 3. Scoring Engine

**职责**: 根据特征计算合并评分

**输入**:
- `SegmentFeatures` - 提取的特征

**输出**:
- `SegmentScore` - 评分结果

**评分规则**:

#### 3.1 TOC 语义分（权重 1.5）

| TOC 层级 | 分值 | 说明 |
|---------|------|------|
| 1 级 | -3 | 强烈倾向创建新章节（仅对非元信息生效） |
| 2 级 | +1 | 倾向合并到父章节 |
| 3 级及以下 | +2 | 强烈倾向合并 |
| 不在 TOC | +2 | 倾向合并 |

#### 3.2 标题强度分（权重 1.2）

| 标题类型 | 分值 | 正则匹配 |
|---------|------|---------|
| 强章标题 | -3 | `^第\s*[一二三四五六七八九十0-9]+\s*章`<br>`^Chapter\s+\d+`<br>`^Part\s+[IVX0-9]+` |
| 弱标题 | +2 | `^\d+\.\d+`<br>`^\d+\.\d+\.\d+`<br>`^§\s*\d+` |
| 无标题 | +1 | - |

#### 3.3 长度合理性分（权重 1.0）

| 字数范围 | 分值 | 说明 |
|---------|------|------|
| < 300 | +3 | 强烈倾向合并 |
| 300-800 | +2 | 倾向合并 |
| 800-2000 | 0 | 中性 |
| 2000-6000 | -1 | 轻微倾向独立 |
| > 6000 | -2 | 倾向独立 |

#### 3.4 内容类型分（权重 1.0）

| 内容类型 | 分值 | 关键词 |
|---------|------|--------|
| 版权页 | +5 | ISBN, Copyright, 版权, 出版社, 印刷, 发行 |
| 目录 | +5 | 目录, 导航, Contents, TOC |
| 序言 | +5 | 序, 序言, 前言, 致谢, Preface, Acknowledgments |
| 正文 | 0 | - |

#### 3.5 位置惩罚分（权重 0.8）

| 条件 | 分值 |
|-----|------|
| 位于前 5% 且非强章 | +2 |
| 位于后 5% | +1 |
| 紧跟强章标题 | +1 |
| 连续两个强章标题 | -1 |

#### 3.6 连续性分（权重 0.8）

| 条件 | 分值 |
|-----|------|
| 编号连续（1.1 → 1.2） | +2 |
| 编号跳跃（1.3 → 2.1） | -1 |
| 无编号 | 0 |

**总分计算**:
```
TotalScore = Σ(score × weight)
```

**代码位置**: `src-tauri/src/reading_unit/scoring_engine.rs`

---

### 4. Decision Engine

**职责**: 根据评分和特征做出合并决策

**输入**:
- `SegmentScore` - 评分结果
- `SegmentFeatures` - 特征数据
- `Segment` - 片段数据

**输出**:
- `(MergeDecision, String, Option<u32>)` - (决策, 原因, 层级)

**决策流程**:

```
┌─────────────────────────────────────┐
│ 优先级 1: 内容类型判断                │
│ content_score >= +5?                │
│ (版权页/目录/序言)                   │
└──────────┬──────────────────────────┘
           │ 是 → 合并（标记为 frontmatter）
           │ 否 ↓
┌─────────────────────────────────────┐
│ 优先级 2: TOC 一级节点 + 非元信息     │
│ tocLevel == 1 AND content_score < 5?│
└──────────┬──────────────────────────┘
           │ 是 → 创建新章节（level=1）
           │ 否 ↓
┌─────────────────────────────────────┐
│ 优先级 3: TOC 二级节点                │
│ tocLevel == 2?                      │
└──────────┬──────────────────────────┘
           │ 是 → 创建新小节（level=2）
           │ 否 ↓
┌─────────────────────────────────────┐
│ 优先级 4: 评分模型                    │
│ TotalScore >= +3?                   │
└──────────┬──────────────────────────┘
           │ 是 → 合并
           │ 否 ↓
┌─────────────────────────────────────┐
│ TotalScore <= -3?                   │
└──────────┬──────────────────────────┘
           │ 是 → 创建新章节
           │ 否 ↓
┌─────────────────────────────────────┐
│ 灰区处理                             │
│ length < 800?                       │
└──────────┬──────────────────────────┘
           │ 是 → 合并
           │ 否 → 创建新章节
```

**代码位置**: `src-tauri/src/reading_unit/decision_engine.rs`

---

### 5. Reading Unit Builder

**职责**: 根据决策构建最终的 Reading Unit 结构

**输入**:
- `Segment[]` - 片段列表
- `[(MergeDecision, String, Option<u32>)]` - 决策列表

**输出**:
- `ReadingUnit[]` - 最终章节结构

**关键功能**:
- 合并 segments 到 Reading Unit
- 处理章-节两层层级关系
- 自动关联 parent_id（level=2 时）
- 标记 contentType（frontmatter/body/backmatter）
- 生成唯一 ID

**代码位置**: `src-tauri/src/reading_unit/reading_unit_builder.rs`

---

### 6. Fallback Strategy

**职责**: 当评分计算失败时使用的降级策略

**输入**:
- `Segment` - 片段数据

**输出**:
- `(MergeDecision, String)` - (决策, 原因)

**简单规则**:
1. 如果标题匹配强章标题正则 → 创建新章节
2. 否则如果长度 < 800 → 合并
3. 否则 → 创建新章节

**代码位置**: `src-tauri/src/reading_unit/fallback_strategy.rs`

---

## 数据库设计

### reading_units 表

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | TEXT | 主键，格式：ru-{book_id}-{unit_id} |
| book_id | INTEGER | 书籍 ID |
| title | TEXT | 章节标题 |
| level | INTEGER | 层级（1=章，2=节） |
| parent_id | TEXT | 父节点 ID（level=2 时有值） |
| segment_ids | TEXT | Segment ID 列表（JSON） |
| start_block_id | INTEGER | 起始 block ID |
| end_block_id | INTEGER | 结束 block ID |
| source | TEXT | 来源（'toc' 或 'heuristic'） |
| content_type | TEXT | 内容类型（'frontmatter'/'body'/'backmatter'） |
| summary_text | TEXT | AI 摘要文本 |
| summary_generated_at | INTEGER | 摘要生成时间 |
| summary_model | TEXT | 使用的 AI 模型 |
| created_at | INTEGER | 创建时间 |

### debug_segment_scores 表

| 字段 | 类型 | 说明 |
|-----|------|------|
| segment_id | TEXT | 主键 |
| book_id | INTEGER | 书籍 ID |
| scores | TEXT | 各维度分数（JSON） |
| weights | TEXT | 权重配置（JSON） |
| total_score | REAL | 总分 |
| decision | TEXT | 决策（'merge' 或 'new'） |
| decision_reason | TEXT | 决策原因 |
| fallback | INTEGER | 是否使用降级策略（0/1） |
| fallback_reason | TEXT | 降级原因 |
| content_type | TEXT | 内容类型 |
| level | INTEGER | 层级 |
| created_at | INTEGER | 创建时间 |

---

## 测试覆盖

### 单元测试（43 个）

- **types.rs**: 3 个测试
  - 评分计算
  - 序列化/反序列化

- **segment_builder.rs**: 3 个测试
  - 正文长度计算
  - 标题提取
  - 从 block 提取标题

- **feature_extractor.rs**: 7 个测试
  - 标题强度识别
  - 长度特征提取
  - 内容类型识别
  - 章节编号提取
  - 编号连续性判断

- **scoring_engine.rs**: 6 个测试
  - 各维度评分计算
  - 总分计算

- **decision_engine.rs**: 8 个测试
  - 4 层决策优先级
  - 灰区处理
  - 层级判断

- **reading_unit_builder.rs**: 8 个测试
  - 简单结构构建
  - 合并逻辑
  - 两层层级结构
  - 内容类型判断

- **fallback_strategy.rs**: 5 个测试
  - 强章标题识别
  - 长度判断
  - 各种章节模式

### 集成测试（3 个）

- **test_full_pipeline_simple_book**: 测试完整流程（版权页 + 多章）
- **test_full_pipeline_with_sections**: 测试两层结构（章 + 节）
- **test_fallback_strategy**: 测试降级策略

**测试结果**: 46/46 通过 ✅

---

## 使用示例

```rust
use reading_unit::*;

// 1. 构建 Segments
let segment_builder = SegmentBuilder::new(book_id, SourceFormat::Epub);
let segments = segment_builder.build_segments(&chapters, &conn)?;

// 2. 提取特征并评分
let extractor = FeatureExtractor::new();
let scorer = ScoringEngine::new();
let decider = DecisionEngine::new();

let mut decisions = Vec::new();
for (i, segment) in segments.iter().enumerate() {
    let prev = if i > 0 { Some(&segments[i - 1]) } else { None };

    // 提取特征
    let features = extractor.extract_features(segment, prev);

    // 计算评分
    let score = scorer.calculate_score(&features);

    // 做出决策
    let decision = decider.make_decision(&score, &features, segment);

    decisions.push(decision);
}

// 3. 构建 Reading Units
let builder = ReadingUnitBuilder::new(book_id);
let reading_units = builder.build(&segments, &decisions)?;

// 4. 持久化到数据库
for unit in reading_units {
    // 保存到 reading_units 表
    save_reading_unit(&conn, &unit)?;
}
```

---

## 性能优化

### 计算时机
- **导入时一次性计算**: 在书籍导入流程中完成章节合并
- **结果持久化**: 将 Reading Unit 结构保存到数据库
- **阅读时直接读取**: 不重新计算，保证阅读性能

### 规则版本管理
- 每本书记录使用的规则版本（`chapter_rule_version`）
- 已导入书籍保持原有章节结构
- 只有新导入的书籍使用新规则

---

## 可扩展性

### 添加新的评分维度

1. 在 `SegmentFeatures` 中添加新特征
2. 在 `FeatureExtractor` 中实现特征提取
3. 在 `ScoringEngine` 中添加评分逻辑
4. 更新权重配置

### 调整评分权重

```rust
let mut scorer = ScoringEngine::new();
let mut weights = HashMap::new();
weights.insert("toc".to_string(), 2.0);  // 增加 TOC 权重
weights.insert("heading".to_string(), 1.5);
// ...
scorer.set_weights(weights);
```

### 调整决策阈值

```rust
let mut decider = DecisionEngine::new();
decider.set_thresholds(
    4.0,   // merge_threshold
    -4.0,  // new_threshold
    1000   // gray_zone_length
);
```

---

## 故障排查

### Debug 数据

系统会将每个 Segment 的评分明细保存到 `debug_segment_scores` 表，包括：
- 各维度分数
- 权重配置
- 总分
- 决策结果和原因
- 是否使用降级策略

### 常见问题

**Q: 为什么版权页没有被合并？**

A: 检查以下几点：
1. 版权页是否被正确识别（content_score 应该 >= 5）
2. 如果版权页是第一个 segment，会创建独立 unit（符合预期）
3. 查看 debug_segment_scores 表的决策原因

**Q: 为什么某些章节被错误合并？**

A: 可能原因：
1. 标题没有被正确识别为强章标题
2. 章节长度过短（< 800）触发灰区合并
3. TOC 信息缺失或不准确

解决方案：
- 调整正则表达式匹配规则
- 调整灰区长度阈值
- 检查 TOC 解析逻辑

---

## 参考文档

- [章节合并评分规则 PRD](章节合并评分规则_prd.md)
- [Bug 修复总结](../README.md#bug修复总结)
- [测试报告](../README.md#测试覆盖)

---

## 更新日志

### v1.0.0 (2026-01-12)
- ✅ 实现 6 维度评分模型
- ✅ 实现 4 层决策优先级
- ✅ 支持章-节两层层级
- ✅ 实现降级策略
- ✅ 完成 46 个单元测试和集成测试
- ✅ 修复 4 个关键 bug

---

**维护者**: Deep Reader Team
**最后更新**: 2026-01-12
