# DeepReader 多格式导入重构 PRD

## 1. 项目概览 (Project Overview)
DeepReader 目前仅支持 EPUB 格式，限制了用户在多样化阅读场景下的使用。本项目旨在重构导入系统，引入 **IRP (Intermediate Reading Representation)** 架构。通过将多种文档格式（EPUB, PDF, MD, TXT, HTML）统一解析为结构化的 IRP 并永久存储于本地数据库，实现阅读体验标准化、AI 处理精准化，并彻底脱离对原始文件的依赖。

## 2. 核心业务需求 (Core Requirements)
*   **多格式兼容性**：支持主流电子书及文档格式的深度解析。
*   **离线化与独立性**：导入后用户可删除原始文件，书籍（含图片）仍可正常阅读及搜索。
*   **高性能阅读**：通过预解析和 Block 级存储，实现大型文档的秒开和流畅滚动。
*   **AI 友好型数据**：提供纯净的结构化文本块，提升 AI 摘要、翻译和问答的准确率。

## 3. 核心功能 (Core Features)

### 3.1 Parser Router (解析路由)
*   **自动分发**：根据文件扩展名自动匹配解析引擎。
*   **质量分级 (Parse Quality)**：
    *   `native`：原生结构（如 HTML/EPUB）。
    *   `light`：文本可提取但结构不稳定（如 PDF）。
    *   `experimental`：尽力而为（如扫描件识别预留）。

### 3.2 三层回退式章节引擎
*   **第一层：显式识别**：正则匹配 Markdown 标题（`#`）、HTML 标签（`<h1>`）或特定关键字（`第X章`、`Chapter X`）。
*   **第二层：结构性推断**：针对无目录长文，基于连续段落数和空行进行逻辑切分。
*   **第三层：线性模式**：完全无法识别时，作为单一章节处理。
*   **置信度标记**：在 UI 上显式标注章节是“原文自带”还是“自动划分”。

### 3.3 异步导入与状态管理
*   **后台处理**：支持多任务并行解析，不阻塞用户主界面。
*   **状态反馈**：前端显示“解析中”、“索引构建中”、“已完成”等实时状态。
*   **访问控制**：在书籍完全转换为 IRP 之前，限制进入阅读模式以确保体验一致。

### 3.4 渐进式全文检索 (FTS5)
*   **策略**：导入时同步构建标题索引，空闲时后台渐进式补全全文 Block 索引。
*   **能力**：支持跨书籍的精确段落定位。

## 4. 核心组件 (Core Components)

### 4.1 IRP 存储管理 (IRP Manager)
*   **Block 数据模型 (ADM)**：采用 `TextRun` + `TextMark` 解耦结构，支持加粗、斜体、链接、代码块。
*   **持久化层**：基于 SQLite，`runs` 数组采用 JSON 序列化存储。

### 4.2 资产管理器 (Asset Manager)
*   **图片脱离**：解析时自动提取图片，重命名并存储至应用私有数据目录 (`app_data_dir/assets/{book_id}/`)。

### 4.3 阅读进度引擎
*   **高精度记录**：数据库记录精确到 `block_id`。
*   **前端映射**：UI 呈现为“章节名 + 百分比”。

## 5. 应用/用户流程 (App/User Flow)

1.  **用户操作**：点击“导入”，选择一个或多个文件。
2.  **后台启动**：
    *   Parser Router 识别格式并分配引擎。
    *   创建 `Book` 记录，状态设为 `Parsing`。
    *   提取图片至私有目录。
    *   按章节生成 `Chapter` 和 `Block` (JSON)。
3.  **UI 呈现**：书架出现占位卡片，显示解析进度。
4.  **解析完成**：状态更新为 `Completed`，用户可点击进入阅读器。
5.  **阅读/搜索**：阅读器从数据库加载 Block 渲染；后台静默构建 FTS5 索引。

## 6. 技术栈 (Techstack)

*   **后端 (Tauri/Rust)**：
    *   `tokio`：后台异步任务调度。
    *   `rusqlite`：数据库操作（含 FTS5 插件）。
    *   `serde_json`：IRP Block 的序列化。
    *   `epub-rs`, `pdf-rs`, `pulldown-cmark`：格式解析库。
*   **前端 (React/TypeScript)**：
    *   `Tailwind CSS`：UI 布局。
    *   `Lucide React`：图标展示。
    *   自定义虚拟列表渲染器：处理数万个 Block 的高性能滚动。

## 7. 实施计划 (Implementation Plan)

### 第一阶段：基础设施 (Week 1)
*   重构 SQLite Schema，增加 `chapters` 和 `blocks` 表。
*   实现 IRP 核心数据结构及 JSON 存取逻辑。

### 第二阶段：解析引擎重构 (Week 2)
*   实现 Parser Router 基类。
*   完成 EPUB、TXT、Markdown 的解析适配。
*   开发三层回退章节识别算法。

### 第三阶段：异步流程与资产管理 (Week 3)
*   建立后台解析任务队列。
*   实现图片提取及本地路径映射逻辑。
*   前端增加导入状态感知 UI。

### 第四阶段：阅读器适配与搜索优化 (Week 4)
*   将阅读器数据源从本地文件切换为 IRP 数据库。
*   接入 FTS5 渐进式索引构建逻辑。
*   阅读进度精确到 Block 级的联调。