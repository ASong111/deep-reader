# IRP + Dolphin 多格式导入功能 PRD（MVP 集成）

## 1. 背景与目标

### 1.1 背景问题
当前阅读器在实际使用中面临以下核心痛点：
- 高质量 EPUB 电子书难以获取，尤其是技术书、非虚构、长文档
- PDF / Word / 网页 / 扫描文档格式各异，排版混乱
- 不同格式直接渲染会破坏沉浸式阅读体验
- AI 功能（摘要、名词释义）强依赖“结构化、语义连续”的文本

### 1.2 设计目标
通过 **Dolphin → IRP（Intermediate Reading Protocol）** 的方式，实现：
- 多格式统一导入
- 内容结构标准化
- 为沉浸式阅读 + AI 功能提供稳定数据基础

**一句话目标：**
> 不管用户导入什么格式，进入阅读器后，都“像一本好 EPUB”。

### 1.3 MVP 范围声明（非常重要）
本 PRD 仅覆盖 **导入 → 解析 → 注入现有阅读器体系**，不涉及：
- DRM
- 在线书城
- 协作 / 分享
- 复杂排版还原（表格、公式仅基础支持）

---

## 2. 总体方案概述

### 2.1 技术路线
```
原始文件
 (PDF / EPUB / DOCX / HTML / TXT)
        ↓
     Dolphin
 (文档解析 / 结构提取)
        ↓
        IRP
 (统一中间阅读协议)
        ↓
  现有阅读器渲染层
        ↓
 AI 摘要 / 名词释义
```

### 2.2 IRP 的产品定位
- **不是文件格式**
- 是阅读器内部的“内容操作系统”
- 所有功能（阅读、标注、AI）只依赖 IRP，不感知原始格式

---

## 3. 用户使用流程（产品视角）

### 3.1 导入流程
1. 用户点击「导入书籍」
2. 选择本地文件（支持多选）
3. 显示解析中状态
4. 解析完成 → 出现在书架

**关键体验要求：**
- 用户无需关心文件格式
- 无需选择“导入为 EPUB / PDF”
- 失败时给出明确原因（而非技术错误）

---

## 4. 支持的格式（MVP）

| 格式 | 支持等级 | 说明 |
|----|----|----|
| EPUB | 完整支持 | 作为基准格式 |
| PDF | 重点支持 | 通过 Dolphin 结构化 |
| DOCX | 支持 | 转换为章节 + 段落 |
| HTML | 支持 | 单页 / 多页合并 |
| TXT / MD | 基础支持 | 按规则切分 |

---

## 5. IRP 设计（产品导向）

### 5.1 IRP 核心原则
- **可阅读优先于可还原**
- **语义结构优先于视觉结构**
- **为 AI 而生**

### 5.2 IRP 核心实体（简化版）

#### 5.2.1 Book
- id
- title
- author
- language
- metadata（来源、原始格式等）

#### 5.2.2 Chapter
- id
- book_id
- order
- title

#### 5.2.3 Block（最关键）
- id
- chapter_id
- type（paragraph / heading / quote / code / image）
- text
- semantic_role（正文 / 注释 / 示例等）

**说明：**
- Block 是阅读、标注、AI 的最小操作单元

---

## 6. Dolphin → IRP 映射规则（产品约束）

### 6.1 章节识别
- 优先使用 Dolphin 的 heading 结构
- 无 heading 时，按分页或长度智能切分
- 禁止生成过长章节（影响摘要体验）

### 6.2 段落规则
- 一段 = 一个 Block
- 禁止跨页拼接无语义段落
- 代码块 / 引用必须独立 Block

### 6.3 异常处理
- 页眉页脚：自动过滤
- 重复段落：去重
- OCR 噪声：基础清洗

---

## 7. 与现有阅读器的集成方式

### 7.1 渲染层
- 阅读器只消费 IRP
- 不关心原始文件格式
- 分页 / 滚动逻辑不变

### 7.2 笔记与标注
- anchor 到 Block.id + offset
- 不依赖页码（解决 PDF 痛点）

---

## 8. 为 AI 功能预留的产品能力

### 8.1 智能摘要
- 输入：Chapter / Block list
- 输出：结构化摘要
- 可缓存到 IRP 扩展字段

### 8.2 名词释义
- 输入：选中词 + Block 上下文
- 输出：短解释
- 结果与 Book 绑定缓存

---

## 9. 性能与体验要求（MVP）

- 导入时允许异步
- 大文件允许后台解析
- 阅读时不再访问 Dolphin
- IRP 本地存储（SQLite）

---

## 10. 明确不做的事情（MVP）

- 不追求 100% 版式还原
- 不支持复杂数学公式渲染
- 不支持扫描版高精度 OCR 校对
- 不做用户可编辑 IRP

---

## 11. 成功标准（验收）

- 用户导入 PDF 后，不再觉得“这是个 PDF”
- AI 摘要不因格式问题失效
- 同一本书不同格式导入，阅读体验一致

---

## 12. 产品一句话总结

> **IRP + Dolphin 的意义，不是支持更多格式，而是让格式从用户世界中消失。**

